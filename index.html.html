
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moffitt HVLS Layout Tool — hvls-1 (300×200, fullscreen option)</title>
  <style>
    :root{ --bg:#ffffff; --ink:#0f172a; --muted:#64748b; --border:#d0d7de; --accent:#0067c5; --panel:#f8fafc; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif; color:var(--ink); background:var(--bg); }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 16px; border-bottom:1px solid var(--border); background:#fff; position:sticky; top:0; z-index:10 }
    h1{ font-size:18px; margin:0; font-weight:700 }
    .sub{ color:var(--muted); font-size:12px }
    main{ display:grid; grid-template-columns:360px 1fr; gap:0; height:calc(100vh - 60px); min-height:500px }
    aside{ border-right:1px solid var(--border); overflow:auto; background:var(--panel); padding:12px }
    section.canvas-host{ position:relative; min-height:400px }
    #stage{ position:absolute; inset:0; background:#fff; touch-action:none }
    .group{ background:#fff; border:1px solid var(--border); border-radius:8px; padding:10px 10px 6px; margin-bottom:12px }
    .group h2{ font-size:14px; margin:0 0 8px 0 }
    label{ display:block; font-size:12px; color:var(--muted); margin:6px 0 4px }
    input[type="number"], input[type="text"], select{ width:100%; padding:8px; border:1px solid var(--border); border-radius:6px; font-size:13px }
    input[type="file"]{ width:100% }
    .row{ display:flex; gap:8px }
    .row > *{ flex:1 }
    .btn{ appearance:none; border:1px solid var(--border); background:#fff; padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:600; font-size:13px }
    .btn.primary{ background:var(--accent); color:#fff; border-color:var(--accent) }
    .btn.ghost{ background:#eef2f7 }
    .btn.danger{ background:#fee2e2; border-color:#fecaca; color:#7f1d1d }
    .hint{ color:var(--muted); font-size:12px }
    .chip{ display:inline-block; padding:4px 8px; border:1px solid var(--border); border-radius:999px; margin:2px; cursor:pointer; font-size:12px }
    .chip[data-active="true"]{ background:#e6f0fb; border-color:#b6d4fe; color:#0b4ea2 }
    .flex{ display:flex; gap:8px; align-items:center }
    .space{ flex:1 }
    .kbd{ border:1px solid var(--border); padding:2px 6px; border-radius:4px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace; font-size:11px }
    .toolbar{ position:absolute; top:8px; left:8px; display:flex; gap:8px; background:#ffffffcc; border:1px solid var(--border); border-radius:8px; padding:6px; backdrop-filter:saturate(160%) blur(4px) }
    .legend{ position:absolute; bottom:8px; left:8px; background:#ffffffcc; border:1px solid var(--border); border-radius:8px; padding:6px 8px; font-size:12px; color:#334155 }
    .overlay{ position:absolute; inset:0; pointer-events:none }
    .fs-tip{ color:#64748b; font-size:12px; margin-left:8px }
  </style>
</head>
<body>
<header>
  <div>
    <h1>Moffitt HVLS Layout Tool — Floorplan + Rectangular Graphics</h1>
    <div class="sub">Drag to move fans; <span class="kbd">Delete</span> removes; hold <span class="kbd">Space</span> to pan; mouse wheel to zoom.</div>
  </div>
  <div class="flex">
    <button class="btn" id="btnUpdate">Update Preview</button>
    <button class="btn" id="btnReset">Reset</button>
    <button class="btn" id="btnFullscreen">Enter Fullscreen</button>
    <span class="fs-tip">Press <span class="kbd">F</span> to toggle fullscreen</span>
    <button class="btn primary" id="btnPNG">Download PNG</button>
    <button class="btn" id="btnPDF">Export PDF</button>
  </div>
</header>
<main>
  <aside>
    <div class="group">
      <h2>Layout Source</h2>
      <div class="row">
        <label><input type="radio" name="srcMode" value="rect" checked> Rectangular perimeter</label>
        <label><input type="radio" name="srcMode" value="image"> Floorplan image (upload)</label>
      </div>
      <div id="rectInputs">
        <div class="row">
          <div>
            <label>Width (ft)</label>
            <input type="number" id="rectW" min="1" value="300" step="1">
          </div>
          <div>
            <label>Height (ft)</label>
            <input type="number" id="rectH" min="1" value="200" step="1">
          </div>
        </div>
        <label>Tick interval (ft)</label>
        <input type="number" id="tick" min="1" value="25" step="1">
        <div class="row">
          <label class="flex"><input type="checkbox" id="showGrid" checked> Show grid & tick labels</label>
          <label class="flex"><input type="checkbox" id="showDims" checked> Show dimension arrows</label>
        </div>
      </div>
      <div id="imageInputs" style="display:none">
        <label>Floorplan (PNG/JPG)</label>
        <input type="file" id="imgFile" accept="image/png,image/jpeg" />
        <div class="hint">Tip: use a clean, high‑resolution floor plan.</div>
        <div style="border-top:1px dashed var(--border); margin:8px 0"></div>
        <h3 style="font-size:13px; margin:4px 0">Calibrate scale</h3>
        <div class="hint">Click two known points on the plan, then enter their distance.</div>
        <div class="row">
          <button class="btn" id="btnPickPts">Pick 2 points</button>
          <input type="number" id="calDistFt" placeholder="Distance (ft)" min="0.1" step="0.1" value="30">
          <button class="btn" id="btnApplyCal">Apply</button>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="hint" id="calStatus">No calibration yet.</div>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btn ghost" id="btnFitRectToImg">Fit rectangle to image</button>
          <button class="btn ghost" id="btnCenter">Center view</button>
        </div>
      </div>
    </div>

    <div class="group">
      <h2>Fans & Coverage</h2>
      <div class="row">
        <div>
          <label>Default diameter (ft)</label>
          <input type="number" id="defDia" min="4" step="1" value="24">
        </div>
        <div>
          <label>DPI (PNG export)</label>
          <input type="number" id="dpi" min="72" step="1" value="150">
        </div>
      </div>
      <div>
        <div class="hint">Presets:</div>
        <div id="presetBar"></div>
      </div>
      <div class="row" style="margin-top:6px">
        <div>
          <label>Number of fans</label>
          <input type="number" id="fanCount" min="0" step="1" value="1">
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="btnApplyCount">Apply Count</button>
        <button class="btn" id="btnAutoGrid">Auto place (grid)</button>
        <button class="btn danger" id="btnClearFans">Clear</button>
      </div>
      <div style="margin-top:6px">
        <h3 style="font-size:13px; margin:4px 0">Per‑fan editor</h3>
        <div id="fanList" class="hint">No fans yet.</div>
      </div>
    </div>

    <div class="group">
      <h2>About</h2>
      <div class="hint">Defaults on open: 300×200 ft, 25 ft ticks, 24 ft fan, 1 fan. Fullscreen: button or press F (Esc to exit).</div>
    </div>
  </aside>

  <section class="canvas-host" id="canvasHost">
    <canvas id="stage"></canvas>
    <div class="toolbar">
      <div class="hint">Zoom: wheel • Pan: hold <span class="kbd">Space</span> + drag</div>
      <div class="space"></div>
      <div class="hint">Selected fan: <span id="selInfo">none</span></div>
    </div>
    <div class="legend" id="legend">Scale: <span id="scaleInfo">—</span> px/ft</div>
    <div class="overlay" id="clickOverlay"></div>
  </section>
</main>

<script>
(() => {
  const DIM_OFFSET_FT = 48, DIM_OFFSET_PX = 48;
  const circleMap = new Map([[8,31.5],[10,35],[12,38.5],[14,42],[16,53],[18,56.5],[20,60],[24,67]]);
  const circleDiaFor = d => circleMap.get(Number(d)) ?? Number(d);

  const state = { mode:'rect', rectW:300, rectH:200, tick:25, showGrid:true, showDims:true, dpi:150, defDia:24, presets:[8,10,12,14,16,18,20,24], fans:[], selId:null, img:null, imgPxPerFt:3, imgPts:[], pan:{x:0,y:0}, zoom:2.8, isPanning:false, pickingPts:false };

  const $ = s=>document.querySelector(s);
  const stage = document.getElementById('stage');
  const ctx = stage.getContext('2d');
  const overlay = document.getElementById('clickOverlay');
  const canvasHost = document.getElementById('canvasHost');
  const btnFS = document.getElementById('btnFullscreen');
  const inputs={ srcRadios:document.querySelectorAll('input[name="srcMode"]'), rectW:$('#rectW'), rectH:$('#rectH'), tick:$('#tick'), showGrid:$('#showGrid'), showDims:$('#showDims'), imgFile:$('#imgFile'), calDistFt:$('#calDistFt'), btnPickPts:$('#btnPickPts'), btnApplyCal:$('#btnApplyCal'), calStatus:$('#calStatus'), btnFitRectToImg:$('#btnFitRectToImg'), btnCenter:$('#btnCenter'), defDia:$('#defDia'), fanCount:$('#fanCount'), btnApplyCount:$('#btnApplyCount'), btnAutoGrid:$('#btnAutoGrid'), btnClearFans:$('#btnClearFans'), dpi:$('#dpi'), presetBar:$('#presetBar'), fanList:$('#fanList'), selInfo:$('#selInfo'), scaleInfo:$('#scaleInfo'), btnUpdate:$('#btnUpdate'), btnReset:$('#btnReset'), btnPNG:$('#btnPNG'), btnPDF:$('#btnPDF') };

  // ----- Fullscreen helpers -----
  function isFullscreen(){ return document.fullscreenElement === canvasHost; }
  async function enterFS(){ try{ await canvasHost.requestFullscreen(); }catch(e){} }
  async function exitFS(){ try{ if(document.fullscreenElement) await document.exitFullscreen(); }catch(e){} }
  function toggleFS(){ isFullscreen() ? exitFS() : enterFS(); }
  document.addEventListener('fullscreenchange', ()=>{
    btnFS.textContent = isFullscreen()? 'Exit Fullscreen' : 'Enter Fullscreen';
    // After any chrome reflow, make sure canvas gets resized
    resize();
  });
  btnFS.addEventListener('click', toggleFS);
  // Keyboard shortcut: F to toggle fullscreen
  window.addEventListener('keydown', (e)=>{
    if(e.key.toLowerCase()==='f' && !e.repeat){ e.preventDefault(); toggleFS(); }
  });

  function initUI(){
    inputs.srcRadios.forEach(r=>r.addEventListener('change',()=>{ state.mode=r.value; $('#rectInputs').style.display=state.mode==='rect'?'':'none'; $('#imageInputs').style.display=state.mode==='image'?'':'none'; centerView(); render(); }));
    inputs.rectW.addEventListener('input',()=>{ state.rectW=parseFloat(inputs.rectW.value)||0; centerView(); render(); });
    inputs.rectH.addEventListener('input',()=>{ state.rectH=parseFloat(inputs.rectH.value)||0; centerView(); render(); });
    inputs.tick.addEventListener('input',()=>{ state.tick=Math.max(0.1,parseFloat(inputs.tick.value)||25); render(); });
    inputs.showGrid.addEventListener('change',()=>{ state.showGrid=inputs.showGrid.checked; render(); });
    inputs.showDims.addEventListener('change',()=>{ state.showDims=inputs.showDims.checked; render(); });

    inputs.imgFile && inputs.imgFile.addEventListener('change',(e)=>{ const f=e.target.files&&e.target.files[0]; if(!f) return; const url=URL.createObjectURL(f); const img=new Image(); img.onload=()=>{ state.img=img; if(!state.imgPxPerFt) state.imgPxPerFt=img.width/100; centerView(); render(); }; img.src=url; });
    inputs.btnPickPts && inputs.btnPickPts.addEventListener('click',()=>{ state.pickingPts=true; state.imgPts=[]; inputs.calStatus.textContent='Pick two points on the plan…'; });
    inputs.btnApplyCal && inputs.btnApplyCal.addEventListener('click',()=>{ const dft=parseFloat(inputs.calDistFt.value); if(state.imgPts.length===2 && dft>0){ const [a,b]=state.imgPts; const distFeet=Math.hypot(b.x-a.x,b.y-a.y); state.imgPxPerFt*=(distFeet/dft); inputs.calStatus.textContent=`Calibrated: 1 ft = ${state.imgPxPerFt.toFixed(2)} px`; state.imgPts=[]; state.pickingPts=false; centerView(); render(); } });
    inputs.btnFitRectToImg && inputs.btnFitRectToImg.addEventListener('click',()=>{ if(!state.img) return; state.rectW=Math.round(state.img.width/state.imgPxPerFt); state.rectH=Math.round(state.img.height/state.imgPxPerFt); inputs.rectW.value=state.rectW; inputs.rectH.value=state.rectH; centerView(); render(); });
    inputs.btnCenter && inputs.btnCenter.addEventListener('click',()=>{ centerView(); render(); });

    inputs.defDia.addEventListener('input',()=> state.defDia=parseFloat(inputs.defDia.value)||24);
    inputs.btnApplyCount.addEventListener('click',()=>{ const n=Math.max(0,parseInt(inputs.fanCount.value)||0); while(state.fans.length<n){ const id=(self.crypto&&crypto.randomUUID?crypto.randomUUID():String(Math.random()).slice(2)); state.fans.push({id,x:10+5*state.fans.length,y:10,diameter:state.defDia}); } while(state.fans.length>n){ state.fans.pop(); } refreshFanList(); render(); });
    inputs.btnAutoGrid.addEventListener('click', autoPlaceGrid);
    inputs.btnClearFans.addEventListener('click',()=>{ state.fans=[]; state.selId=null; refreshFanList(); render(); });
    inputs.dpi.addEventListener('input',()=> state.dpi=Math.max(72,parseInt(inputs.dpi.value)||150));

    inputs.presetBar.innerHTML=''; [8,10,12,14,16,18,20,24].forEach(d=>{ const b=document.createElement('span'); b.className='chip'; b.textContent=`${d} ft`; b.addEventListener('click',()=>{ state.defDia=d; inputs.defDia.value=d; document.querySelectorAll('#presetBar .chip').forEach(c=>c.dataset.active='false'); b.dataset.active='true'; }); inputs.presetBar.appendChild(b); });

    inputs.btnUpdate.addEventListener('click',()=>{ render(); });
    inputs.btnReset.addEventListener('click',()=>location.reload());
    inputs.btnPNG.addEventListener('click',exportPNG);
    inputs.btnPDF.addEventListener('click',exportPDF);

    refreshFanList();
  }

  function resize(){
    const host=stage.parentElement.getBoundingClientRect();
    let w=Math.floor(host.width), h=Math.floor(host.height);
    if(!(w>1 && h>1)){
      w = Math.max(600, window.innerWidth - 380);
      h = Math.max(400, window.innerHeight - 100);
      stage.style.width = w + 'px'; stage.style.height = h + 'px';
    }
    const dpr=Math.max(1,window.devicePixelRatio||1);
    stage.width=Math.floor(w*dpr); stage.height=Math.floor(h*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    render();
  }
  window.addEventListener('resize', resize);

  let isDraggingFan=false, dragOffset={x:0,y:0};
  function canvasToWorld(px,py){ return { x:(px-state.pan.x)/state.zoom, y:(py-state.pan.y)/state.zoom }; }
  function centerView(){
    const host=stage.parentElement.getBoundingClientRect();
    const contentW=(state.mode==='image'&&state.img)? state.img.width/state.imgPxPerFt : state.rectW;
    const contentH=(state.mode==='image'&&state.img)? state.img.height/state.imgPxPerFt : state.rectH;
    const cx=(host.width||window.innerWidth)/2, cy=(host.height||window.innerHeight)/2;
    state.pan.x=cx-(contentW*state.zoom)/2;
    state.pan.y=cy-(contentH*state.zoom)/2;
  }
  function hitFan(x,y){ for(let i=state.fans.length-1;i>=0;i--){ const f=state.fans[i]; const r=Math.max(f.diameter/2, circleDiaFor(f.diameter)/2); if(Math.hypot(x-f.x,y-f.y)<=r) return f.id; } return null; }

  stage.addEventListener('mousedown',(e)=>{ const r=stage.getBoundingClientRect(); const x=e.clientX-r.left, y=e.clientY-r.top; if(e.button!==0) return; if(e.shiftKey){ const w=canvasToWorld(x,y); addFanAt(w.x,w.y); return; } if(state.pickingPts){ const w=canvasToWorld(x,y); state.imgPts.push(w); render(); return; } const w=canvasToWorld(x,y); const hitId=hitFan(w.x,w.y); if(hitId){ state.selId=hitId; const f=state.fans.find(f=>f.id===hitId); dragOffset.x=w.x-f.x; dragOffset.y=w.y-f.y; isDraggingFan=true; refreshFanList(); render(); } });
  stage.addEventListener('mousemove',(e)=>{ if(!isDraggingFan) return; const r=stage.getBoundingClientRect(); const x=e.clientX-r.left, y=e.clientY-r.top; const w=canvasToWorld(x,y); const f=state.fans.find(f=>f.id===state.selId); if(f){ f.x=w.x-dragOffset.x; f.y=w.y-dragOffset.y; render(); } });
  stage.addEventListener('mouseleave',()=>{ isDraggingFan=false; });
  window.addEventListener('mouseup',()=>{ isDraggingFan=false; });

  window.addEventListener('keydown',(e)=>{ if(e.code==='Space'){ state.isPanning=true; overlay && (overlay.style.cursor='grab'); } if(e.code==='Delete'||e.code==='Backspace'){ if(state.selId){ state.fans=state.fans.filter(f=>f.id!==state.selId); state.selId=null; refreshFanList(); render(); } } });
  window.addEventListener('keyup',(e)=>{ if(e.code==='Space'){ state.isPanning=false; overlay && (overlay.style.cursor='default'); } });
  stage.addEventListener('wheel',(e)=>{ e.preventDefault(); const scale=Math.exp(-e.deltaY*0.0015); const r=stage.getBoundingClientRect(); const mx=r.width/2, my=r.height/2; const before=canvasToWorld(mx,my); state.zoom*=scale; state.zoom=Math.min(40,Math.max(0.2,state.zoom)); const after=canvasToWorld(mx,my); state.pan.x += (mx - (after.x*state.zoom + state.pan.x)); state.pan.y += (my - (after.y*state.zoom + state.pan.y)); render(); },{passive:false});

  function drawFanSymbol(c, f, forExport=false){
    const rFan = f.diameter/2;
    const rCircle = circleDiaFor(f.diameter)/2;
    const grad = c.createRadialGradient(f.x, f.y, rCircle*0.10, f.x, f.y, rCircle);
    grad.addColorStop(0.00, '#d8f1ff');
    grad.addColorStop(0.55, '#aee2fb');
    grad.addColorStop(1.00, '#7fc8ef');
    c.save(); c.beginPath(); c.arc(f.x, f.y, rCircle, 0, Math.PI*2); c.fillStyle = grad; c.fill();
    c.lineWidth = Math.max(1, rCircle * 0.012);
    c.strokeStyle = 'rgba(110, 186, 230, 0.35)';
    c.shadowColor = 'rgba(110, 186, 230, 0.25)';
    c.shadowBlur  = Math.max(2, rCircle * 0.05);
    c.stroke(); c.restore();
    const baseAngle = -0.1;
    c.save(); c.translate(f.x, f.y); c.rotate(baseAngle); c.strokeStyle = '#111';
    if(forExport){ c.lineWidth = 2; } else { const dpr=(window.devicePixelRatio||1); c.lineWidth = 2/(dpr*state.zoom); }
    c.lineCap='round'; for(let i=0;i<5;i++){ const a=i*(2*Math.PI/5); c.beginPath(); c.moveTo(0,0); c.lineTo(Math.cos(a)*rFan*0.9, Math.sin(a)*rFan*0.9); c.stroke(); } c.restore();
    c.beginPath(); c.arc(f.x, f.y, Math.max(0.5, rFan*0.03), 0, Math.PI*2); c.fillStyle='#111'; c.fill();
    return rCircle;
  }

  function drawFans(){ ctx.save(); ctx.translate(state.pan.x,state.pan.y); ctx.scale(state.zoom,state.zoom); for(const f of state.fans){ const rCircle = drawFanSymbol(ctx, f, false); ctx.font = `${13/state.zoom}px sans-serif`; ctx.textAlign='center'; ctx.textBaseline='top'; ctx.fillStyle='#0f172a'; ctx.fillText(`${f.diameter} ft`, f.x, f.y + rCircle + 2/state.zoom); if(state.selId===f.id){ ctx.setLineDash([6/state.zoom,4/state.zoom]); ctx.strokeStyle='#f59e0b'; ctx.strokeRect(f.x-rCircle, f.y-rCircle, rCircle*2, rCircle*2); ctx.setLineDash([]); } } ctx.restore(); }
  function drawFansToContext(c){ for(const f of state.fans){ const rCircle=drawFanSymbol(c,f,true); c.font='13px sans-serif'; c.textAlign='center'; c.textBaseline='top'; c.fillStyle='#0f172a'; c.fillText(`${f.diameter} ft`, f.x, f.y + rCircle + 2); } }

  function drawGridAndDims(){ if(!state.showGrid && !state.showDims) return; ctx.save(); ctx.translate(state.pan.x,state.pan.y); ctx.scale(state.zoom,state.zoom); const W=state.rectW,H=state.rectH; if(state.showGrid){ ctx.lineWidth=1/state.zoom; ctx.strokeStyle='#e5e7eb'; const t=Math.max(0.1,state.tick); for(let x=0;x<=W+1e-6;x+=t){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); } for(let y=0;y<=H+1e-6;y+=t){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); } ctx.strokeStyle='#94a3b8'; ctx.lineWidth=2/state.zoom; ctx.strokeRect(0,0,W,H); ctx.fillStyle='#475569'; ctx.font=`${12/state.zoom}px sans-serif`; ctx.textAlign='center'; ctx.textBaseline='top'; for(let x=0;x<=W+1e-6;x+=t){ ctx.fillText(String(x), x, H + 2/state.zoom); } ctx.save(); ctx.textAlign='right'; ctx.textBaseline='middle'; for(let y=0;y<=H+1e-6;y+=t){ ctx.fillText(String(y), -2/state.zoom, y); } ctx.restore(); } if(state.showDims){ const off=DIM_OFFSET_PX/state.zoom; const arrow=(x1,y1,x2,y2,label)=>{ ctx.strokeStyle='#0b4ea2'; ctx.fillStyle='#0b4ea2'; ctx.lineWidth=2/state.zoom; ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); const head=(x,y,dx,dy)=>{ const len=Math.hypot(dx,dy); if(len<1e-6) return; const ux=dx/len, uy=dy/len; const s=6/state.zoom; ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x-ux*s-uy*s*0.6, y-uy*s+ux*s*0.6); ctx.lineTo(x-ux*s+uy*s*0.6, y-uy*s-ux*s*0.6); ctx.closePath(); ctx.fill(); }; head(x1,y1,x2-x1,y2-y1); head(x2,y2,x1-x2,y1-y2); ctx.font=`${14/state.zoom}px sans-serif`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(label, (x1+x2)/2, (y1+y2)/2 - 10/state.zoom); }; arrow(0,H+off,W,H+off,`${W} ft`); arrow(-off,0,-off,H,`${H} ft`); } ctx.restore(); }
  function drawGridAndDimsToContext(c){ const W=state.rectW,H=state.rectH; if(state.showGrid){ c.lineWidth=1; c.strokeStyle='#e5e7eb'; const t=Math.max(0.1,state.tick); for(let x=0;x<=W+1e-6;x+=t){ c.beginPath(); c.moveTo(x,0); c.lineTo(x,H); c.stroke(); } for(let y=0;y<=H+1e-6;y+=t){ c.beginPath(); c.moveTo(0,y); c.lineTo(W,y); c.stroke(); } c.strokeStyle='#94a3b8'; c.lineWidth=2; c.strokeRect(0,0,W,H); c.fillStyle='#475569'; c.font='12px sans-serif'; c.textAlign='center'; c.textBaseline='top'; for(let x=0;x<=W+1e-6;x+=t){ c.fillText(String(x), x, H + 2); } c.textAlign='right'; c.textBaseline='middle'; for(let y=0;y<=H+1e-6;y+=t){ c.fillText(String(y), -2, y); } } if(state.showDims){ const off=DIM_OFFSET_FT; const arrow=(x1,y1,x2,y2,label)=>{ c.strokeStyle='#0b4ea2'; c.fillStyle='#0b4ea2'; c.lineWidth=2; c.beginPath(); c.moveTo(x1,y1); c.lineTo(x2,y2); c.stroke(); const head=(x,y,dx,dy)=>{ const len=Math.hypot(dx,dy); if(len<1e-6) return; const ux=dx/len, uy=dy/len; const s=6; c.beginPath(); c.moveTo(x,y); c.lineTo(x-ux*s-uy*s*0.6, y-uy*s+ux*s*0.6); c.lineTo(x-ux*s+uy*s*0.6, y-uy*s-ux*s*0.6); c.closePath(); c.fill(); }; head(x1,y1,x2-x1,y2-y1); head(x2,y2,x1-x2,y1-y2); c.font='14px sans-serif'; c.textAlign='center'; c.textBaseline='middle'; c.fillText(label, (x1+x2)/2, (y1+y2)/2 - 10); }; arrow(0,H+off,W,H+off,`${W} ft`); arrow(-off,0,-off,H,`${H} ft`); } }

  function drawImage(){ if(state.mode!=='image'||!state.img) return; ctx.save(); ctx.translate(state.pan.x,state.pan.y); ctx.scale(state.zoom,state.zoom); const wft=state.img.width/state.imgPxPerFt; const hft=state.img.height/state.imgPxPerFt; ctx.imageSmoothingEnabled=true; ctx.drawImage(state.img,0,0,wft,hft); ctx.restore(); }

  function getContentBounds(){ let w=state.rectW,h=state.rectH; if(state.mode==='image'&&state.img){ const wft=state.img.width/state.imgPxPerFt, hft=state.img.height/state.imgPxPerFt; w=Math.max(w,wft); h=Math.max(h,hft); } return {x:0,y:0,w,h}; }

  function exportPNG(){ const b=getContentBounds(); const dpi=state.dpi; const scale=dpi; const Wpx=Math.max(1,Math.round(b.w*scale)); const Hpx=Math.max(1,Math.round(b.h*scale)); const off=document.createElement('canvas'); off.width=Wpx; off.height=Hpx; const c=off.getContext('2d'); c.fillStyle='#fff'; c.fillRect(0,0,Wpx,Hpx); c.save(); c.scale(scale,scale); c.translate(-b.x,-b.y); if(state.mode==='image'&&state.img){ const wft=state.img.width/state.imgPxPerFt, hft=state.img.height/state.imgPxPerFt; c.drawImage(state.img,0,0,wft,hft); } drawGridAndDimsToContext(c); drawFansToContext(c); c.restore(); off.toBlob((blob)=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='HVLS_Floorplan.png'; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },1000); },'image/png'); }

  function exportPDF(){ const b=getContentBounds(); const off=document.createElement('canvas'); const scale=200; off.width=Math.max(1,Math.round(b.w*scale)); off.height=Math.max(1,Math.round(b.h*scale)); const c=off.getContext('2d'); c.fillStyle='#fff'; c.fillRect(0,0,off.width,off.height); c.save(); c.scale(scale,scale); c.translate(-b.x,-b.y); if(state.mode==='image'&&state.img){ const wft=state.img.width/state.imgPxPerFt, hft=state.img.height/state.imgPxPerFt; c.drawImage(state.img,0,0,wft,hft); } drawGridAndDimsToContext(c,true); drawFansToContext(c); c.restore(); const dataUrl=off.toDataURL('image/png'); const w=window.open('','_blank'); w.document.write(`<!doctype html><title>Export PDF</title><style>@page{size:auto;margin:10mm}body{margin:0}img{width:100%;height:auto}</style><img src="${dataUrl}"/>`); w.document.close(); w.focus(); w.print(); }

  function addFanAt(x,y){ const f={id:(self.crypto&&crypto.randomUUID?crypto.randomUUID():String(Math.random()).slice(2)), x, y, diameter:state.defDia}; state.fans.push(f); state.selId=f.id; refreshFanList(); render(); }
  function refreshFanList(){ const box=inputs.fanList; box.innerHTML=''; if(!state.fans.length){ box.textContent='No fans yet. Shift+click on canvas to add.'; return; } state.fans.forEach((f,idx)=>{ const row=document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='6px'; row.style.margin='6px 0'; const lbl=document.createElement('div'); lbl.textContent=`#${idx+1}`; lbl.style.width='28px'; lbl.style.color='#475569'; const dia=document.createElement('input'); dia.type='number'; dia.min='1'; dia.step='1'; dia.value=f.diameter; dia.style.width='80px'; dia.addEventListener('input',()=>{ f.diameter=parseFloat(dia.value)||f.diameter; render(); }); const x=document.createElement('input'); x.type='number'; x.step='0.1'; x.value=f.x.toFixed(1); x.style.width='90px'; x.addEventListener('input',()=>{ f.x=parseFloat(x.value)||f.x; render(); }); const y=document.createElement('input'); y.type='number'; y.step='0.1'; y.value=f.y.toFixed(1); y.style.width='90px'; y.addEventListener('input',()=>{ f.y=parseFloat(y.value)||f.y; render(); }); const sel=document.createElement('button'); sel.className='btn ghost'; sel.textContent='Select'; sel.addEventListener('click',()=>{ state.selId=f.id; render(); inputs.selInfo && (inputs.selInfo.textContent=`#${idx+1} at (${f.x.toFixed(1)}, ${f.y.toFixed(1)})`); }); const del=document.createElement('button'); del.className='btn danger'; del.textContent='Delete'; del.addEventListener('click',()=>{ state.fans=state.fans.filter(g=>g.id!==f.id); if(state.selId===f.id) state.selId=null; refreshFanList(); render(); }); row.append(lbl, span('Dia'), dia, span('X'), x, span('Y'), y, sel, del); box.appendChild(row); }); }
  function span(t){ const s=document.createElement('span'); s.textContent=t; s.className='hint'; return s; }
  function autoPlaceGrid(){ const count=Math.max(0, parseInt(inputs.fanCount.value)||state.fans.length||1); const W=state.rectW, H=state.rectH; const d=state.defDia; const cols=Math.ceil(Math.sqrt(count*W/H)); const rows=Math.ceil(count/cols); const pad=d*0.6; const gw=(W-2*pad)/Math.max(1,cols-1); const gh=(H-2*pad)/Math.max(1,rows-1); state.fans=[]; for(let r=0,i=0;r<rows && i<count;r++){ for(let c=0;c<cols && i<count;c++,i++){ const x=pad+c*gw; const y=pad+r*gh; state.fans.push({id:String(i+1), x, y, diameter:d}); } } refreshFanList(); render(); }
  function updateSelectionInfo(){ const f=state.fans.find(f=>f.id===state.selId); inputs.selInfo && (inputs.selInfo.textContent = f?`#${state.fans.indexOf(f)+1} at (${f.x.toFixed(1)}, ${f.y.toFixed(1)})`:'none'); }

  function placeDefaultFanIfNeeded(){ if(state.fans.length===0){ const cx = state.rectW/2; const cy = state.rectH/2; addFanAt(cx, cy); inputs.fanCount && (inputs.fanCount.value = '1'); inputs.defDia && (inputs.defDia.value = String(state.defDia)); } }

  function render(){ ctx.clearRect(0,0,stage.width,stage.height); ctx.fillStyle='#fff'; ctx.fillRect(0,0,stage.width,stage.height); inputs.scaleInfo && (inputs.scaleInfo.textContent = state.imgPxPerFt ? state.imgPxPerFt.toFixed(2) : '—'); if(state.mode==='image' && state.img){ drawImage(); drawGridAndDims(); } else { drawGridAndDims(); } drawFans(); }
  function boot(){ initUI(); resize(); centerView(); placeDefaultFanIfNeeded(); render(); }
  if(document.readyState==='complete' || document.readyState==='interactive'){ setTimeout(boot,0); } else { document.addEventListener('DOMContentLoaded', boot); }
})();
</script>
</body>
</html>
